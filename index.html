<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Echoes of the Forgotten - Platformer</title>
<style>
  body { margin:0; font-family:sans-serif; background:#111; overflow:hidden; }
  #gameCanvas { display:block; margin:0 auto; background:#000; }
  #cutscene { position:absolute; top:0; left:0; width:100%; height:100%; 
              background: rgba(0,0,0,0.85); color:#fff; display:flex; 
              justify-content:center; align-items:center; text-align:center;
              font-size:24px; padding:20px; display:none; cursor:pointer; }
  #hud { position:absolute; top:0; left:0; width:100%; height:50px; 
         background: linear-gradient(90deg,#444,#111); display:flex; 
         align-items:center; justify-content:space-around; color:#fff; font-weight:bold; font-size:18px; }
  button { padding:6px 12px; background:#555; border:none; border-radius:6px; color:white; cursor:pointer; transition:0.2s; }
  button:hover { background:#777; }
</style>
</head>
<body>

<audio id="bgMusic" loop>
  <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
</audio>

<div id="hud">
  <span id="healthBar">Health: 3</span>
  <button id="pauseBtn">Pause</button>
  <button id="restartBtn">Restart</button>
  <button id="musicBtn">Music: On</button>
</div>

<canvas id="gameCanvas" width="900" height="500"></canvas>
<div id="cutscene"></div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const cutsceneDiv = document.getElementById('cutscene');
const bgMusic = document.getElementById('bgMusic');
const healthBar = document.getElementById('healthBar');
const pauseBtn = document.getElementById('pauseBtn');
const restartBtn = document.getElementById('restartBtn');
const musicBtn = document.getElementById('musicBtn');

let paused=false, musicOn=true, inCutscene=true;

// HUD buttons
pauseBtn.addEventListener('click', ()=> paused=!paused);
restartBtn.addEventListener('click', ()=> restartLevel());
musicBtn.addEventListener('click', ()=>{
  musicOn = !musicOn;
  musicOn ? bgMusic.play() : bgMusic.pause();
  musicBtn.innerText = "Music: "+(musicOn?"On":"Off");
});

// Player state
let player = { x:50, y:400, width:40, height:50, color:'cyan', speed:5, vy:0, onGround:false, health:3 };
let keys = {};

// Keyboard
document.addEventListener('keydown', e=>keys[e.key.toLowerCase()]=true);
document.addEventListener('keyup', e=>keys[e.key.toLowerCase()]=false);

// Levels (harder as you progress)
const maps = [
  {
    bg:'https://i.ibb.co/1JpY9H3/bg1.jpg', // background image
    platforms: [
      {x:0,y:450,width:900,height:50},
      {x:200,y:350,width:120,height:20},
      {x:450,y:300,width:120,height:20},
      {x:700,y:250,width:120,height:20}
    ],
    enemies:[ {x:300,y:400,width:40,height:40,color:'red',dir:1,speed:2} ],
    puzzle:{x:750,y:200,width:40,height:40,solved:false},
    cutscenes:[
      "Kael enters the ruins, shadows stir...",
      "Avoid the guardians and solve the ancient puzzle!"
    ]
  },
  {
    bg:'https://i.ibb.co/2n6dkK5/bg2.jpg',
    platforms:[
      {x:0,y:450,width:900,height:50},
      {x:150,y:380,width:100,height:20},
      {x:350,y:320,width:150,height:20},
      {x:600,y:260,width:150,height:20},
      {x:750,y:200,width:100,height:20}
    ],
    enemies:[
      {x:200,y:400,width:40,height:40,color:'red',dir:1,speed:2.5},
      {x:500,y:350,width:40,height:40,color:'red',dir:-1,speed:2}
    ],
    puzzle:{x:770,y:160,width:40,height:40,solved:false},
    cutscenes:[
      "Level 2: The shadows grow restless...",
      "Move quickly and solve the puzzle before they reach you!"
    ]
  }
];

let currentLevel=0, level=maps[currentLevel];

// Cutscene
let currentCutscene=0;
function showCutscene(text){
  cutsceneDiv.style.display='flex';
  cutsceneDiv.innerText=text;
}
cutsceneDiv.addEventListener('click', ()=>{
  currentCutscene++;
  if(currentCutscene<level.cutscenes.length) showCutscene(level.cutscenes[currentCutscene]);
  else { cutsceneDiv.style.display='none'; inCutscene=false; currentCutscene=0; if(musicOn) bgMusic.play();}
});

// Collision
function rectCollision(a,b){
  return a.x < b.x+b.width && a.x+a.width > b.x &&
         a.y < b.y+b.height && a.y+a.height > b.y;
}

// Gravity & Platforms
function applyGravity(player){
  player.vy += 0.8; // gravity
  player.y += player.vy;
  player.onGround=false;
  for(let plat of level.platforms){
    if(rectCollision(player,{...plat,height:1})){
      player.y = plat.y - player.height;
      player.vy=0;
      player.onGround=true;
    }
  }
}

// Restart
function restartLevel(){
  player.x=50; player.y=400; player.vy=0; player.health=3;
  level.puzzle.solved=false;
  inCutscene=true;
  currentCutscene=0;
  showCutscene(level.cutscenes[0]);
}

// Game loop
function gameLoop(){
  if(!paused){
    // Draw background
    let bgImg = new Image();
    bgImg.src=level.bg;
    ctx.drawImage(bgImg,0,0,canvas.width,canvas.height);

    if(!inCutscene){
      // Gravity
      applyGravity(player);

      // Movement
      if(keys['arrowleft']) player.x -= player.speed;
      if(keys['arrowright']) player.x += player.speed;
      if(keys['arrowup'] && player.onGround) player.vy=-15; // jump

      // Platforms
      ctx.fillStyle='rgba(100,100,100,0.8)';
      for(let plat of level.platforms) ctx.fillRect(plat.x,plat.y,plat.width,plat.height);

      // Player
      ctx.fillStyle=player.color;
      ctx.fillRect(player.x,player.y,player.width,player.height);

      // Enemies
      for(let enemy of level.enemies){
        enemy.x += enemy.dir*enemy.speed;
        if(enemy.x<=0||enemy.x+enemy.width>=canvas.width) enemy.dir*=-1;
        ctx.fillStyle=enemy.color;
        ctx.fillRect(enemy.x,enemy.y,enemy.width,enemy.height);
        if(rectCollision(player,enemy)){
          player.health--;
          healthBar.innerText='Health: '+player.health;
          player.x=50; player.y=400; player.vy=0;
          if(player.health<=0) restartLevel();
        }
      }

      // Puzzle
      ctx.fillStyle=level.puzzle.solved ? 'green' : 'yellow';
      ctx.fillRect(level.puzzle.x,level.puzzle.y,level.puzzle.width,level.puzzle.height);
      if(rectCollision(player,level.puzzle) && keys['e']){
        if(!level.puzzle.solved){
          level.puzzle.solved=true;
          inCutscene=true;
          showCutscene("Puzzle solved! A path forward opens...");
        }
      }

      // Level completion
      if(level.puzzle.solved && player.x>canvas.width-60 && player.y<60){
        currentLevel++;
        if(currentLevel>=maps.length) showCutscene("Congratulations! You uncovered the city secrets!");
        else {
          level=maps[currentLevel];
          restartLevel();
        }
      }

      healthBar.innerText='Health: '+player.health;
    }
  }
  requestAnimationFrame(gameLoop);
}

// Start
showCutscene(level.cutscenes[0]);
gameLoop();
</script>
</body>
</html>
