<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Echoes of the Forgotten - Game</title>
<style>
  body { margin:0; font-family: sans-serif; background: #111; color: #fff; overflow: hidden; }
  #gameCanvas { display: block; margin: 0 auto; background: #222; }
  #cutscene { position: absolute; top:0; left:0; width:100%; height:100%; 
              background: rgba(0,0,0,0.85); color:#fff; display:flex; 
              justify-content:center; align-items:center; text-align:center;
              font-size:24px; padding:20px; display:none; cursor:pointer; }
  #hud { position:absolute; top:0; left:0; width:100%; height:40px; background:#333; display:flex; 
         align-items:center; justify-content:space-around; color:#fff; font-weight:bold; }
  button { padding:5px 10px; background:#555; border:none; color:white; cursor:pointer; }
</style>
</head>
<body>

<audio id="bgMusic" loop>
  <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
</audio>

<div id="hud">
  <span id="healthBar">Health: 3</span>
  <button id="pauseBtn">Pause</button>
  <button id="restartBtn">Restart</button>
  <button id="musicBtn">Music: On</button>
</div>

<canvas id="gameCanvas" width="800" height="500"></canvas>
<div id="cutscene"></div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const cutsceneDiv = document.getElementById('cutscene');
const bgMusic = document.getElementById('bgMusic');
const healthBar = document.getElementById('healthBar');
const pauseBtn = document.getElementById('pauseBtn');
const restartBtn = document.getElementById('restartBtn');
const musicBtn = document.getElementById('musicBtn');

let paused = false;
let musicOn = true;
let inCutscene = true;

// Game state
let player = { x:50, y:400, width:40, height:40, color:'cyan', speed:5, health:3 };
let keys = {};

// HUD events
pauseBtn.addEventListener('click', ()=> paused = !paused);
restartBtn.addEventListener('click', ()=> restartLevel());
musicBtn.addEventListener('click', ()=>{
  musicOn = !musicOn;
  musicOn ? bgMusic.play() : bgMusic.pause();
  musicBtn.innerText = "Music: "+(musicOn?"On":"Off");
});

// Keyboard handling
document.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
document.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

// Game map (simple platform/tile map)
const maps = [
  {
    bgColor:'#222',
    platforms: [
      {x:0, y:450, width:800, height:50}, // ground
      {x:200, y:350, width:100, height:20},
      {x:400, y:300, width:100, height:20},
      {x:600, y:250, width:150, height:20},
    ],
    enemies: [
      {x:300, y:400, width:40, height:40, color:'red', dir:1, speed:2}
    ],
    puzzle: {x:650, y:200, width:40, height:40, solved:false},
    cutscenes:[
      "You are Kael, a young archaeologist uncovering a lost city.",
      "Ancient guardians and puzzles await you in the shadows.",
      "Reach the puzzle and press 'E' to interact!"
    ]
  },
  {
    bgColor:'#333',
    platforms: [
      {x:0, y:450, width:800, height:50}, 
      {x:150, y:380, width:100, height:20},
      {x:350, y:320, width:120, height:20},
      {x:550, y:260, width:100, height:20},
    ],
    enemies: [
      {x:200, y:400, width:40, height:40, color:'red', dir:1, speed:2.5},
      {x:500, y:350, width:40, height:40, color:'red', dir:-1, speed:1.8}
    ],
    puzzle: {x:570, y:220, width:40, height:40, solved:false},
    cutscenes:[
      "Level 2: Shadows deepen, and whispers grow louder...",
      "Solve puzzles and survive the guardians to uncover the truth."
    ]
  }
];

let currentLevel = 0;
let level = maps[currentLevel];

// Cutscene handling
let currentCutscene = 0;
function showCutscene(text){
  cutsceneDiv.style.display='flex';
  cutsceneDiv.innerText=text;
}
cutsceneDiv.addEventListener('click', ()=>{
  currentCutscene++;
  if(currentCutscene<level.cutscenes.length){
    showCutscene(level.cutscenes[currentCutscene]);
  }else{
    cutsceneDiv.style.display='none';
    inCutscene=false;
    currentCutscene=0;
    if(musicOn) bgMusic.play();
  }
});

// Collision detection
function rectCollision(a,b){
  return a.x < b.x+b.width && a.x+a.width > b.x &&
         a.y < b.y+b.height && a.y+a.height > b.y;
}

// Platform collision (simple)
function applyGravity(player){
  player.y += 5; // gravity
  let onGround=false;
  for(let plat of level.platforms){
    if(rectCollision(player, plat) && player.y+player.height<=plat.y+10){
      player.y = plat.y - player.height;
      onGround=true;
    }
  }
  return onGround;
}

// Restart level
function restartLevel(){
  player.x=50; player.y=400; player.health=3;
  level.puzzle.solved=false;
  inCutscene=true;
  currentCutscene=0;
  showCutscene(level.cutscenes[0]);
}

// Game loop
function gameLoop(){
  if(!paused){
    ctx.fillStyle=level.bgColor;
    ctx.fillRect(0,0,canvas.width,canvas.height);

    if(!inCutscene){
      // Movement
      let onGround = applyGravity(player);
      if(keys['arrowleft']) player.x -= player.speed;
      if(keys['arrowright']) player.x += player.speed;
      if(keys['arrowup'] && onGround) player.y -= 15; // jump

      // Draw platforms
      for(let plat of level.platforms){
        ctx.fillStyle='grey';
        ctx.fillRect(plat.x,plat.y,plat.width,plat.height);
      }

      // Draw player
      ctx.fillStyle=player.color;
      ctx.fillRect(player.x,player.y,player.width,player.height);

      // Enemies
      for(let enemy of level.enemies){
        enemy.x += enemy.dir*enemy.speed;
        if(enemy.x<=0||enemy.x+enemy.width>=canvas.width) enemy.dir*=-1;
        ctx.fillStyle=enemy.color;
        ctx.fillRect(enemy.x,enemy.y,enemy.width,enemy.height);
        if(rectCollision(player,enemy)){
          player.health--;
          healthBar.innerText='Health: '+player.health;
          player.x=50; player.y=400;
          if(player.health<=0) restartLevel();
        }
      }

      // Puzzle
      ctx.fillStyle=level.puzzle.solved ? 'green' : 'yellow';
      ctx.fillRect(level.puzzle.x,level.puzzle.y,level.puzzle.width,level.puzzle.height);
      if(rectCollision(player,level.puzzle) && keys['e']){
        if(!level.puzzle.solved){
          level.puzzle.solved=true;
          inCutscene=true;
          showCutscene("Puzzle solved! A path forward opens...");
        }
      }

      // Level completion
      if(level.puzzle.solved && player.x>canvas.width-60 && player.y<60){
        currentLevel++;
        if(currentLevel>=maps.length){
          inCutscene=true;
          showCutscene("Congratulations! You uncovered all the city secrets!");
        }else{
          level=maps[currentLevel];
          restartLevel();
        }
      }

      healthBar.innerText='Health: '+player.health;
    }
  }

  requestAnimationFrame(gameLoop);
}

// Start first cutscene
showCutscene(level.cutscenes[0]);
gameLoop();

</script>
</body>
</html>
