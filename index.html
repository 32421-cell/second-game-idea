<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Echoes of the Forgotten - Mini Game</title>
<style>
  body { margin:0; font-family: sans-serif; background: #111; color: #fff; }
  #gameCanvas { background: #222; display: block; margin: 0 auto; }
  #cutscene { position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
              background: rgba(0,0,0,0.85); color: #fff; display: flex; 
              justify-content: center; align-items: center; text-align: center;
              font-size: 24px; padding: 20px; display: none; cursor: pointer; }
</style>
</head>
<body>

<canvas id="gameCanvas" width="800" height="500"></canvas>
<div id="cutscene"></div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const cutsceneDiv = document.getElementById('cutscene');

let player = { x: 50, y: 400, width: 40, height: 40, color: 'cyan', health: 3 };
let keys = {};
let currentLevel = 0;
let inCutscene = true;

// Define levels with enemies, puzzle triggers, and cutscenes
const levels = [
  {
    bgColor: '#222',
    cutscenes: [
      "You awaken in a mysterious, frozen city...",
      "Echoes of the past whisper around you...",
      "Your journey to uncover the dark secret begins now!"
    ],
    enemies: [{x: 500, y: 400, width: 40, height:40, color:'red'}],
    puzzle: {x: 700, y: 50, width:50, height:50, solved: false, cutscene: "You found an ancient mechanism! Solve it to proceed..."}
  },
  {
    bgColor: '#333',
    cutscenes: [
      "Level 2: You enter the Hall of Shadows...",
      "The ghosts of the city grow restless..."
    ],
    enemies: [
      {x: 300, y: 400, width: 40, height:40, color:'red'},
      {x: 600, y: 300, width: 40, height:40, color:'red'}
    ],
    puzzle: {x: 750, y: 100, width:50, height:50, solved: false, cutscene: "A locked door with strange symbols... Solve the puzzle to unlock it."}
  }
];

// Keyboard handling
document.addEventListener('keydown', e => keys[e.key] = true);
document.addEventListener('keyup', e => keys[e.key] = false);

// Cutscene handling
let currentCutscene = 0;
function showCutscene(text){
  cutsceneDiv.style.display = 'flex';
  cutsceneDiv.innerText = text;
}

cutsceneDiv.addEventListener('click', () => {
  let level = levels[currentLevel];
  currentCutscene++;
  if(currentCutscene < level.cutscenes.length){
    showCutscene(level.cutscenes[currentCutscene]);
  } else {
    cutsceneDiv.style.display = 'none';
    inCutscene = false;
    currentCutscene = 0;
  }
});

// Collision detection
function rectCollision(a,b){
  return a.x < b.x + b.width && a.x + a.width > b.x &&
         a.y < b.y + b.height && a.y + a.height > b.y;
}

// Game loop
function gameLoop(){
  let level = levels[currentLevel];
  ctx.fillStyle = level.bgColor;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  if(!inCutscene){
    // Player movement
    if(keys['ArrowLeft']) player.x -= 4;
    if(keys['ArrowRight']) player.x += 4;
    if(keys['ArrowUp']) player.y -= 4;
    if(keys['ArrowDown']) player.y += 4;

    // Keep player in bounds
    player.x = Math.max(0, Math.min(canvas.width-player.width, player.x));
    player.y = Math.max(0, Math.min(canvas.height-player.height, player.y));

    // Draw player
    ctx.fillStyle = player.color;
    ctx.fillRect(player.x, player.y, player.width, player.height);

    // Draw enemies
    level.enemies.forEach(enemy => {
      ctx.fillStyle = enemy.color;
      ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);

      if(rectCollision(player,enemy)){
        player.health--;
        player.x = 50; player.y = 400; // reset position
        if(player.health <= 0){
          inCutscene = true;
          showCutscene("You have been defeated... Restarting level.");
          player.health = 3;
        }
      }
    });

    // Draw puzzle
    if(!level.puzzle.solved){
      ctx.fillStyle = 'yellow';
      ctx.fillRect(level.puzzle.x, level.puzzle.y, level.puzzle.width, level.puzzle.height);
      if(rectCollision(player, level.puzzle)){
        inCutscene = true;
        showCutscene(level.puzzle.cutscene);
        level.puzzle.solved = true;
      }
    }

    // Level completion
    if(level.puzzle.solved && player.x > canvas.width-60 && player.y < 60){
      currentLevel++;
      if(currentLevel >= levels.length){
        inCutscene = true;
        showCutscene("Congratulations! You uncovered the secrets of the city!");
        return;
      } else {
        inCutscene = true;
        showCutscene(levels[currentLevel].cutscenes[0]);
        player.x = 50; player.y = 400;
      }
    }
  }

  requestAnimationFrame(gameLoop);
}

// Start game
showCutscene(levels[currentLevel].cutscenes[0]);
gameLoop();

</script>
</body>
</html>
