<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Echoes of the Forgotten - Moving Version</title>
<style>
  body { margin:0; font-family: sans-serif; background: #111; color: #fff; }
  #gameCanvas { background: #222; display: block; margin: 0 auto; }
  #cutscene { position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
              background: rgba(0,0,0,0.85); color: #fff; display: flex; 
              justify-content: center; align-items: center; text-align: center;
              font-size: 24px; padding: 20px; display: none; cursor: pointer; }
</style>
</head>
<body>

<canvas id="gameCanvas" width="800" height="500"></canvas>
<div id="cutscene"></div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const cutsceneDiv = document.getElementById('cutscene');

let player = { x: 50, y: 400, width: 40, height: 40, color: 'cyan', health: 3, speed: 5 };
let keys = {};
let inCutscene = true;

// Level setup
const level = {
  bgColor: '#222',
  cutscenes: [
    "You awaken in a mysterious, frozen city...",
    "Echoes of the past whisper around you...",
    "Your journey begins now!"
  ],
  enemies: [
    {x: 500, y: 400, width: 40, height:40, color:'red', dir:1, speed:2},
    {x: 600, y: 300, width: 40, height:40, color:'red', dir:1, speed:1.5}
  ],
  puzzle: {x: 700, y: 50, width:50, height:50, solved: false, cutscene: "You found an ancient mechanism! Solve it to proceed..."}
};

// Keyboard handling
document.addEventListener('keydown', e => keys[e.key] = true);
document.addEventListener('keyup', e => keys[e.key] = false);

// Cutscene handling
let currentCutscene = 0;
function showCutscene(text){
  cutsceneDiv.style.display = 'flex';
  cutsceneDiv.innerText = text;
}
cutsceneDiv.addEventListener('click', () => {
  currentCutscene++;
  if(currentCutscene < level.cutscenes.length){
    showCutscene(level.cutscenes[currentCutscene]);
  } else {
    cutsceneDiv.style.display = 'none';
    inCutscene = false;
  }
});

// Collision detection
function rectCollision(a,b){
  return a.x < b.x + b.width && a.x + a.width > b.x &&
         a.y < b.y + b.height && a.y + a.height > b.y;
}

// Game loop
function gameLoop(){
  ctx.fillStyle = level.bgColor;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  if(!inCutscene){
    // Player movement
    if(keys['ArrowLeft']) player.x -= player.speed;
    if(keys['ArrowRight']) player.x += player.speed;
    if(keys['ArrowUp']) player.y -= player.speed;
    if(keys['ArrowDown']) player.y += player.speed;

    // Keep player in bounds
    player.x = Math.max(0, Math.min(canvas.width-player.width, player.x));
    player.y = Math.max(0, Math.min(canvas.height-player.height, player.y));

    // Draw player
    ctx.fillStyle = player.color;
    ctx.fillRect(player.x, player.y, player.width, player.height);

    // Draw and move enemies
    level.enemies.forEach(enemy => {
      enemy.x += enemy.dir * enemy.speed;
      if(enemy.x <= 0 || enemy.x + enemy.width >= canvas.width) enemy.dir *= -1; // reverse
      ctx.fillStyle = enemy.color;
      ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);

      // Collision
      if(rectCollision(player, enemy)){
        player.health--;
        player.x = 50; player.y = 400; // reset
        if(player.health <= 0){
          inCutscene = true;
          showCutscene("You were hit! Restarting level...");
          player.health = 3;
        }
      }
    });

    // Puzzle
    if(!level.puzzle.solved){
      ctx.fillStyle = 'yellow';
      ctx.fillRect(level.puzzle.x, level.puzzle.y, level.puzzle.width, level.puzzle.height);
      if(rectCollision(player, level.puzzle)){
        inCutscene = true;
        showCutscene(level.puzzle.cutscene);
        level.puzzle.solved = true;
      }
    }

    // Level completion
    if(level.puzzle.solved && player.x > canvas.width-60 && player.y < 60){
      inCutscene = true;
      showCutscene("Level complete! Congratulations!");
    }
  }

  requestAnimationFrame(gameLoop);
}

// Start game
showCutscene(level.cutscenes[0]);
gameLoop();

</script>
</body>
</html>
