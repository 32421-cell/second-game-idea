<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Echoes of the Forgotten - Random Maps</title>
<style>
  body { margin:0; font-family: sans-serif; background: #111; color: #fff; overflow: hidden; }
  #gameCanvas { background: #222; display: block; margin: 0 auto; }
  #cutscene { position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
              background: rgba(0,0,0,0.85); color: #fff; display: flex; 
              justify-content: center; align-items: center; text-align: center;
              font-size: 24px; padding: 20px; display: none; cursor: pointer; }
</style>
</head>
<body>

<audio id="bgMusic" loop>
  <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
</audio>

<canvas id="gameCanvas" width="800" height="500"></canvas>
<div id="cutscene"></div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const cutsceneDiv = document.getElementById('cutscene');
const bgMusic = document.getElementById('bgMusic');

let player = { x: 50, y: 400, width: 40, height: 40, color: 'cyan', health: 3, speed: 5 };
let keys = {};
let inCutscene = true;
let currentLevel = 0;

// Generate random maps
function generateLevel(){
  const enemyCount = Math.floor(Math.random() * 3) + 1;
  const enemies = [];
  for(let i=0;i<enemyCount;i++){
    enemies.push({
      x: Math.random() * 700 + 50,
      y: Math.random() * 400 + 50,
      width: 40,
      height: 40,
      color: 'red',
      dir: Math.random() < 0.5 ? 1 : -1,
      speed: Math.random() * 2 + 1
    });
  }
  return {
    bgColor: `rgb(${Math.random()*50+50},${Math.random()*50+50},${Math.random()*50+50})`,
    cutscenes: [
      `Level ${currentLevel+1}: You enter the mysterious ruins...`,
      "Shadows move as if alive around you..."
    ],
    enemies: enemies,
    puzzle: {
      x: Math.random()*700+50,
      y: Math.random()*300+50,
      width:50,
      height:50,
      solved:false,
      cutscene:"You solved the ancient puzzle! A secret passage opens..."
    }
  };
}

// Start with random level
let level = generateLevel();

// Keyboard handling
document.addEventListener('keydown', e => keys[e.key] = true);
document.addEventListener('keyup', e => keys[e.key] = false);

// Cutscene handling
let currentCutscene = 0;
function showCutscene(text){
  cutsceneDiv.style.display = 'flex';
  cutsceneDiv.innerText = text;
}
cutsceneDiv.addEventListener('click', () => {
  currentCutscene++;
  if(currentCutscene < level.cutscenes.length){
    showCutscene(level.cutscenes[currentCutscene]);
  } else {
    cutsceneDiv.style.display = 'none';
    inCutscene = false;
    currentCutscene = 0;
    bgMusic.play();
  }
});

// Collision detection
function rectCollision(a,b){
  return a.x < b.x + b.width && a.x + a.width > b.x &&
         a.y < b.y + b.height && a.y + a.height > b.y;
}

// Game loop
function gameLoop(){
  ctx.fillStyle = level.bgColor;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  if(!inCutscene){
    // Player movement
    if(keys['ArrowLeft']) player.x -= player.speed;
    if(keys['ArrowRight']) player.x += player.speed;
    if(keys['ArrowUp']) player.y -= player.speed;
    if(keys['ArrowDown']) player.y += player.speed;

    player.x = Math.max(0, Math.min(canvas.width-player.width, player.x));
    player.y = Math.max(0, Math.min(canvas.height-player.height, player.y));

    // Draw player
    ctx.fillStyle = player.color;
    ctx.fillRect(player.x, player.y, player.width, player.height);

    // Move & draw enemies
    level.enemies.forEach(enemy => {
      enemy.x += enemy.dir * enemy.speed;
      if(enemy.x <=0 || enemy.x+enemy.width>=canvas.width) enemy.dir*=-1;
      ctx.fillStyle = enemy.color;
      ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);

      if(rectCollision(player,enemy)){
        player.health--;
        player.x = 50; player.y = 400;
        if(player.health<=0){
          inCutscene = true;
          showCutscene("You were defeated! Restarting level...");
          player.health=3;
        }
      }
    });

    // Puzzle (requires "E" to interact)
    ctx.fillStyle = level.puzzle.solved ? 'green' : 'yellow';
    ctx.fillRect(level.puzzle.x, level.puzzle.y, level.puzzle.width, level.puzzle.height);
    if(rectCollision(player, level.puzzle) && keys['e']){
      if(!level.puzzle.solved){
        level.puzzle.solved = true;
        inCutscene = true;
        showCutscene(level.puzzle.cutscene);
      }
    }

    // Level completion (top-right corner after puzzle)
    if(level.puzzle.solved && player.x > canvas.width-60 && player.y < 60){
      currentLevel++;
      level = generateLevel();
      inCutscene = true;
      showCutscene(level.cutscenes[0]);
      player.x = 50; player.y = 400;
    }
  }

  requestAnimationFrame(gameLoop);
}

// Start game
showCutscene(level.cutscenes[0]);
gameLoop();

</script>
</body>
</html>

